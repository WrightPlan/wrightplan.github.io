<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        body {
            background-color: #f7f9fc;
        }

        .card {
            background-color: #ffffff;
            border: 1px solid #e3e6f0;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            margin-bottom: 1rem;
        }

        .card-header {
            background-color: #e3e6f0;
            border-bottom: 1px solid #e3e6f0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .section .card-header {
            z-index: 1;
        }

        .section .question .card-header {
            z-index: 0;
        }

        .btn-primary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }

        .form-group label {
            color: #5a5c69;
        }

        .form-control {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
        }

        .add-section,
        .add-question,
        .add-choice {
            background-color: #6c757d;
            color: #ffffff;
            border: none;
            border-radius: 0.35rem;
            padding: 0.5rem 1rem;
            margin-top: 1rem;
        }

        .add-section:hover,
        .add-question:hover,
        .add-choice:hover {
            background-color: #5a6268;
        }

        .remove-button {
            background-color: transparent;
            color: #dc3545;
            border: none;
            font-size: 2rem;
            line-height: 1;
            padding: 0;
            cursor: pointer;
        }

        .remove-button:hover {
            color: #c82333;
        }

        .duplicate-button {
            cursor: pointer;
            color: #25384b;
            /* Add color to the icon */
            margin-right: 10px;
            /* Add some spacing between the icons */
        }

        .duplicate-button:hover {
            color: #0056b3;
            /* Darker color on hover */
        }


        .form-check-input {
            margin-left: 0.75rem;
        }

        .drag-handle {
            cursor: move;
            padding: 10px;
        }

        .section-odd {
            background-color: #f8f9fa;
        }

        .section-even {
            background-color: #e9ecef;
        }

        .question-odd {
            background-color: #ffffff;
        }

        .question-even {
            background-color: #efdeaa1f;
        }

        .section,
        .question {
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
            margin-bottom: 1rem;
        }

        .section:hover,
        .question:hover {
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }

        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            z-index: 2;
        }

        .form-container {
            max-width: 100%;
            /* Ensure the form container does not exceed the viewport width */
            margin: 0 auto;
            /* Center the form container */
            padding-bottom: 100px;
            /* Add padding to prevent overlap with the sticky footer */
            position: relative;
            /* Ensure the form container is positioned relative to the sticky footer */
        }

        form {
            padding-bottom: 20px;
        }

        .form-check-label {
            display: inline;
        }

        .sticky-footer .btn {
            margin: 0 10px;
            /* Add some spacing between buttons */
        }

        /* Center the modal horizontally */
        .modal-dialog {
            margin: auto;
            max-width: 70%;
        }

        .file-uploader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        #jsonFileInput {
            display: none;
            /* Hide the default file input */
        }

        .file-uploader-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .file-uploader-label:hover {
            background-color: #0056b3;
        }

        .file-uploader-label i {
            margin-right: 10px;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .question-list {
            margin-top: 2rem;
        }
    </style>
</head>

<body>



    <div class="container mt-5" data-bind="with: formViewModel">
        <h1 class="text-center mb-4">Form Builder</h1>
        <div class="form-container">

            <div class="text-center">
                <p>You can create a new form using the tool, or edit an existing one by uploading a json file into the
                    uploader below.</p>
            </div>
            <div class="file-uploader-container">
                <input type="file" id="jsonFileInput" accept=".json" />
                <label for="jsonFileInput" class="file-uploader-label">
                    <i class="fa fa-upload"></i> Choose a JSON file
                </label>
            </div>
            <form id="formDefinition" data-bind="submit: downloadJSON.bind(formViewModel)">
                <h3>Form Information</h3>
                <div class="form-group">
                    <label for="formId">Form ID</label>
                    <input type="text" class="form-control" id="formId" data-bind="value: formId" required>
                </div>
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" class="form-control" id="title" data-bind="value: title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea class="form-control" id="description" data-bind="value: description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="associatedEntity">Associated Entity</label>
                    <select class="form-control" id="associatedEntity" data-bind="value: associatedEntity" required>
                        <option value="dispatch-job">Dispatch Job</option>
                        <option value="work-order">Work Order</option>
                        <option value="customer-company">Customer Company</option>
                        <option value="employee">Employee</option>
                        <option value="equipment">Equipment</option>
                        <option value="job-site">Job Site</option>
                    </select>
                </div>

                <h2>Sections</h2>
                <div id="sections" class="mb-4" data-bind="foreach: sections">
                    <div class="card mb-4 section"
                        data-bind="attr: { id: 'section_' + sectionId() }, css: { 'section-odd': $index() % 2 === 0, 'section-even': $index() % 2 !== 0 }">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 data-bind="text: 'Section ' + sectionId()"></h3>
                            <div>
                                <span type="button" class="duplicate-button"
                                    data-bind="click: $parent.duplicateSection.bind($parent)">
                                    <i class="fa-solid fa-copy fa-2x"></i>
                                </span>
                                <button type="button" class="remove-button"
                                    data-bind="click: $parent.removeSection.bind($parent)">&times;</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label data-bind="attr: { for: 'sectionTitle_' + sectionId() }">Section
                                    Title</label>
                                <input type="text" class="form-control"
                                    data-bind="attr: { id: 'sectionTitle_' + sectionId() }, value: title" required>
                            </div>
                            <div class="form-group">
                                <label data-bind="attr: { for: 'sectionSubtitle_' + sectionId() }">Section
                                    Subtitle</label>
                                <input type="text" class="form-control"
                                    data-bind="attr: { id: 'sectionSubtitle_' + sectionId() }, value: subtitle">
                            </div>
                            <div class="form-group">
                                <label data-bind="attr: { for: 'sectionHelpText_' + sectionId() }">Section
                                    Help Text</label>
                                <input type="text" class="form-control"
                                    data-bind="attr: { id: 'sectionHelpText_' + sectionId() }, value: sectionHelpText">
                            </div>
                            <div style="display: inline-block; margin-left: 1rem" class="form-group form-check">
                                <label class="form-check-label"
                                    data-bind="attr: { for: 'repeatable_' + sectionId() }">Repeatable?</label>
                                <input type="checkbox" class="form-check-input"
                                    data-bind="attr: { id: 'repeatable_' + sectionId() }, checked: repeatable">
                            </div>
                            <div style="display: inline-block; margin-left: 1rem" data-bind="if: sectionId() > 1"
                                class="form-group form-check">
                                <label class="form-check-label"
                                    data-bind="attr: { for: 'reviewPage_' + sectionId() }">Review Page?</label>
                                <input type="checkbox" class="form-check-input"
                                    data-bind="attr: { id: 'reviewPage_' + sectionId() }, checked: reviewPage">
                            </div>
                            <div style="display: inline-block; margin-left: 1rem" class="form-group form-check">
                                <label class="form-check-label" data-bind="attr: { for: 'newPage_' + sectionId() }">New
                                    Page?</label>
                                <input type="checkbox" class="form-check-input"
                                    data-bind="attr: { id: 'newPage_' + sectionId() }, checked: newPage">
                            </div>
                            <div class="question-list" data-bind="foreach: questions">
                                <div class="card mb-3 question"
                                    data-bind="attr: { id: 'question_' + questionId() }, css: { 'question-odd': $index() % 2 === 0, 'question-even': $index() % 2 !== 0 }">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span class="drag-handle">&#x2630;</span>
                                        <h4 data-bind="text: 'Question: ' + questionId()"></h4>
                                        <div>
                                            <span type="button" class="duplicate-button"
                                                data-bind="click: $parent.duplicateQuestion.bind($parent)">
                                                <i class="fa-solid fa-copy fa-2x"></i>
                                            </span>
                                            <button type="button" class="remove-button"
                                                data-bind="click: $parent.removeQuestion.bind($parent)">&times;</button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label data-bind="attr: { for: 'questionId_' + questionId() }">Question
                                                ID</label>
                                            <input type="text" class="form-control"
                                                data-bind="attr: { id: 'questionId_' + questionId() }, value: questionId"
                                                required>
                                        </div>
                                        <div class="form-group">
                                            <label data-bind="attr: { for: 'questionTitle_' + questionId() }">Question
                                                Title</label>
                                            <input type="text" class="form-control"
                                                data-bind="attr: { id: 'questionTitle_' + questionId() }, value: title"
                                                required>
                                        </div>
                                        <div class="form-group">
                                            <label
                                                data-bind="attr: { for: 'questionSubtitle_' + questionId() }">Question
                                                Subtitle</label>
                                            <input type="text" class="form-control"
                                                data-bind="attr: { id: 'questionSubtitle_' + questionId() }, value: subtitle">
                                        </div>
                                        <div class="form-group">
                                            <label
                                                data-bind="attr: { for: 'questionHelpText_' + questionId() }">Question
                                                Help Text</label>
                                            <input type="text" class="form-control"
                                                data-bind="attr: { id: 'questionHelpText_' + questionId() }, value: questionHelpText">
                                        </div>
                                        <div class="form-group">
                                            <label data-bind="attr: { for: 'questionType_' + questionId() }">Question
                                                Type</label>
                                            <select class="form-control"
                                                data-bind="attr: { id: 'questionType_' + questionId() }, value: type, event: { change: $parent.toggleQuestionFields }">
                                                <option value="acknowledgement">Acknowledgement</option>
                                                <option value="boolean">Boolean</option>
                                                <option value="choice">Choice</option>
                                                <option value="date">Date</option>
                                                <option value="decimal">Decimal</option>
                                                <option value="dispatch-job">Dispatch Job (ID)</option>
                                                <option value="employee">Employee (ID)</option>
                                                <option value="equipment">Equipment (ID)</option>
                                                <option value="geolocation">Geolocation</option>
                                                <option value="initials">Initials</option>
                                                <option value="integer">Integer</option>
                                                <option value="signature">Signature</option>
                                                <option value="text">Text</option>
                                                <option value="time">Time</option>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label>
                                                <input type="checkbox" data-bind="checked: required"> Required
                                            </label>
                                        </div>

                                        <div class="form-group" data-bind="if: type() === 'text'">
                                            <label>
                                                <input type="checkbox" data-bind="checked: multiLineText"> Multi-Line
                                                Text
                                            </label>
                                        </div>
                                        <div class="form-group choices-field" data-bind="if: type() === 'choice'">
                                            <label data-bind="attr: { for: 'choices_' + questionId() }">Choices</label>
                                            <div class="choices-container" data-bind="foreach: choices">
                                                <div class="choice-item mb-2">
                                                    <input type="text" class="form-control d-inline-block w-75"
                                                        data-bind="textInput: $rawData" required>
                                                    <button type="button" class="btn btn-danger d-inline-block w-20"
                                                        data-bind="click: $parent.removeChoice.bind($parent)">Remove</button>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-primary add-choice"
                                                data-bind="click: addChoice.bind($data)">+ Add Choice</button>
                                        </div>
                                        <div class="form-group number-field"
                                            data-bind="visible: type() === 'integer' || type() === 'decimal'">
                                            <label data-bind="attr: { for: 'minimum_' + questionId() }">Minimum</label>
                                            <input type="number" class="form-control"
                                                data-bind="attr: { id: 'minimum_' + questionId() }, value: minimum">
                                        </div>
                                        <div class="form-group number-field"
                                            data-bind="visible: type() === 'integer' || type() === 'decimal'">
                                            <label class="form-check-label"
                                                data-bind="attr: { for: 'exclusiveMinimum_' + questionId() }">Exclusive
                                                Minimum?</label>
                                            <input type="checkbox" class="form-check-input"
                                                data-bind="attr: { id: 'exclusiveMinimum_' + questionId() }, checked: exclusiveMinimum">
                                        </div>
                                        <div class="form-group number-field"
                                            data-bind="visible: type() === 'integer' || type() === 'decimal'">
                                            <label data-bind="attr: { for: 'maximum_' + questionId() }">Maximum</label>
                                            <input type="number" class="form-control"
                                                data-bind="attr: { id: 'maximum_' + questionId() }, value: maximum">
                                        </div>
                                        <div class="form-group number-field"
                                            data-bind="visible: type() === 'integer' || type() === 'decimal'">
                                            <label class="form-check-label"
                                                data-bind="attr: { for: 'exclusiveMaximum_' + questionId() }">Exclusive
                                                Maximum?</label>
                                            <input type="checkbox" class="form-check-input"
                                                data-bind="attr: { id: 'exclusiveMaximum_' + questionId() }, checked: exclusiveMaximum">
                                        </div>
                                        <div class="form-group multiChoice-field"
                                            data-bind="visible: type() === 'choice'">
                                            <label data-bind="attr: { for: 'multiChoice_' + questionId() }">Multi
                                                Choice?</label>
                                            <input type="checkbox" class="form-check-input"
                                                data-bind="attr: { id: 'multiChoice_' + questionId() }, checked: multiChoice">
                                        </div>
                                        <div class="form-group for-annotation"
                                            data-bind="visible: type() === 'signature' || type() === 'initials'">
                                            <label data-bind="attr: { for: 'forAnnotation_' + questionId() }">For
                                                (Question
                                                Id)</label>
                                            <pre data-bind="text: ko.toJSON($root.forAnnotationOptions, null, 2)"></pre>

                                            <select class="form-control"
                                                data-bind="attr: { id: 'forAnnotation_' + questionId() }, value: forAnnotation">
                                                <option value="">Select a question</option>
                                                <!-- ko foreach: $root.formViewModel.forAnnotationOptions -->
                                                <option data-bind="text: $data, value: $data"></option>
                                                <!-- /ko -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn btn-primary add-question"
                                data-bind="click: addQuestion.bind($data)">+ Add Question</button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary add-section"
                    data-bind="click: addSection.bind(formViewModel)">+ Add Section</button>

                <div class="sticky-footer">
                    <button type="button" class="btn btn-primary mt-3" data-bind="click: previewJSON">Preview
                        JSON</button>
                    <button type="submit" class="btn btn-success mt-3">Download JSON</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Structure -->
    <div id="jsonModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">JSON Preview</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <pre id="jsonPreview"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/knockout@3.5.1/build/output/knockout-latest.js"></script>
    <script>

        class QuestionViewModel {
            constructor(sectionId, questionId) {
                this.sectionId = sectionId;
                this.questionId = ko.observable(questionId);
                this.title = ko.observable('');
                this.subtitle = ko.observable('');
                this.questionHelpText = ko.observable('');
                this.type = ko.observable('');
                this.choices = ko.observableArray([ko.observable(' ')]);
                this.minimum = ko.observable(null);
                this.maximum = ko.observable(null);
                this.exclusiveMinimum = ko.observable(false);
                this.exclusiveMaximum = ko.observable(false);
                this.multiChoice = ko.observable(false);
                this.multiLineText = ko.observable(false);
                this.required = ko.observable(false);
                this.forAnnotation = ko.observable(null);

                this.type.subscribe(newValue => {
                    this.removeUnnecessaryFields();
                });
            }

            removeUnnecessaryFields() {

                if (this.type() !== 'choice' && this.choices()) {
                    this.choices?.removeAll();
                    this.multiChoice(false);
                } else {
                    this.addChoice();
                }

                if (this.type() !== 'text') {
                    this.multiLineText(false);
                }


                if (this.type() !== 'integer' && this.type() !== 'decimal') {
                    this.minimum(null);
                    this.maximum(null);
                    this.exclusiveMinimum(false);
                    this.exclusiveMaximum(false);
                }

            }

            addChoice() {
                this.choices.push(ko.observable(' '));
            }

            removeChoice(choice) {
                this.choices.remove(item => item.peek() === choice);
            }
        }

        class SectionViewModel {
            constructor(sectionId) {
                this.sectionId = ko.observable(sectionId);
                this.title = ko.observable('');
                this.subtitle = ko.observable('');
                this.sectionHelpText = ko.observable('');
                this.repeatable = ko.observable(false);
                this.newPage = ko.observable(false);
                this.reviewPage = ko.observable(false);
                this.questions = ko.observableArray([]);
            }

            addQuestion() {
                this.questions.push(new QuestionViewModel(this.sectionId(), ''));
            }

            removeQuestion(question) {
                if (confirm('Are you sure you want to remove this question?')) {
                    const section = formViewModel.sections().find(section => section.sectionId() === this.sectionId());
                    section.questions.remove(question);
                }
            }

            duplicateQuestion(question) {
                //duplicate the question and add it to the section
                const newQuestion = new QuestionViewModel(this.sectionId(), question.questionId());
                newQuestion.title(question.title());
                newQuestion.subtitle(question.subtitle());
                newQuestion.questionHelpText(question.questionHelpText());
                newQuestion.type(question.type());
                newQuestion.choices(question.choices()?.map(choice => ko.observable(choice())));
                newQuestion.minimum(question.minimum());
                newQuestion.maximum(question.maximum());
                newQuestion.exclusiveMinimum(question.exclusiveMinimum());
                newQuestion.exclusiveMaximum(question.exclusiveMaximum());
                newQuestion.multiChoice(question.multiChoice());
                newQuestion.multiLineText(question.multiLineText());
                newQuestion.required(question.required());
                newQuestion.forAnnotation(question.forAnnotation());
                this.questions.push(newQuestion);
            }

        }

        class FormViewModel {
            constructor() {
                this.formId = ko.observable('');
                this.title = ko.observable('');
                this.description = ko.observable('');
                this.associatedEntity = ko.observable('');
                this.sections = ko.observableArray([]);
                this.forAnnotationOptions = ko.observableArray([]);

                ko.computed(() => {
                    this.forAnnotationOptions(this.sections().reduce((acc, section) => {
                        section.questions().forEach(question => {
                            if (question.type() === 'geolocation' || question.type() === 'acknowledgement') {
                                acc.push(question.questionId());
                            }
                        });
                        return acc;
                    }, []));
                });

            }

            addSection() {
                const sectionId = this.sections().length + 1;
                this.sections.push(new SectionViewModel(sectionId));
                this.renumberSections();
            }

            removeSection(section) {
                if (confirm('Are you sure you want to remove this section?')) {
                    this.sections.remove(section);
                } this.renumberSections();
            }

            duplicateSection(section) {
                //duplicate the section and add it to the form
                const newSection = new SectionViewModel(this.sections().length + 1);
                newSection.title(section.title());
                newSection.subtitle(section.subtitle());
                newSection.repeatable(section.repeatable());
                newSection.newPage(section.newPage());
                newSection.sectionHelpText(section.sectionHelpText());
                section.questions().forEach(question => {
                    const newQuestion = new QuestionViewModel(newSection.sectionId(), question.questionId());
                    newQuestion.title(question.title());
                    newQuestion.subtitle(question.subtitle());
                    newQuestion.questionHelpText(question.questionHelpText());
                    newQuestion.type(question.type());
                    newQuestion.choices(question.choices().map(choice => ko.observable(choice())));
                    newQuestion.minimum(question.minimum());
                    newQuestion.maximum(question.maximum());
                    newQuestion.exclusiveMinimum(question.exclusiveMinimum());
                    newQuestion.exclusiveMaximum(question.exclusiveMaximum());
                    newQuestion.multiChoice(question.multiChoice());
                    newQuestion.multiLineText(question.multiLineText());
                    newQuestion.required(question.required());
                    newQuestion.forAnnotation(question.forAnnotation());
                    newSection.questions.push(newQuestion);
                });
                this.sections.push(newSection);
                this.renumberSections();
            }

            renumberSections() {
                this.sections().forEach((section, index) => {
                    section.sectionId(index + 1);
                });
            }

            previewJSON() {
                if (!this.validateForm()) {
                    return;
                }

                const cleanedJson = this.createJsonFromViewModel(this);

                // Insert JSON into the modal
                document.getElementById('jsonPreview').textContent = JSON.stringify(cleanedJson, null, 2);

                // Display the modal
                $('#jsonModal').modal('show');
            };

            downloadJSON() {
                if (!this.validateForm()) {
                    return;
                }

                const cleanedJson = this.createJsonFromViewModel(this)

                // Extract form title to use as filename
                const formTitle = this.title() || 'form'; // Replace with actual form title property
                const filename = `${formTitle}.json`;

                // Create a Blob from the JSON data
                const blob = new Blob([JSON.stringify(cleanedJson, null, 2)], { type: 'application/json' });

                // Create a link element
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;

                // Programmatically click the link to trigger the download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            createJsonFromViewModel(viewModel) {
                const json = ko.toJS(this);
                delete json.forAnnotationOptions;

                json.sections.forEach(section => {
                    delete section.sectionId;
                    section.questions = section.questions
                        .filter(question => question !== null && question !== false && question !== '')
                        .map(question => {
                            delete question.sectionId;

                            // Rename forAnnotation to for
                            if (question.forAnnotation) {
                                question.for = question.forAnnotation;
                                delete question.forAnnotation;
                            }

                            // If question type is integer or decimal, the min/max values should be numbers
                            if (question.type === 'integer' || question.type === 'decimal') {
                                question.minimum = question.minimum ? Number(question.minimum) : null;
                                question.maximum = question.maximum ? Number(question.maximum) : null;
                            }

                            // Replace minimum with exclusiveMinimum
                            if (question.exclusiveMinimum && question.minimum !== undefined) {
                                question.exclusiveMinimum = question.minimum;
                                delete question.minimum;
                            }
                            if (question.exclusiveMaximum && question.maximum !== undefined) {
                                question.exclusiveMaximum = question.maximum;
                                delete question.maximum;
                            }

                            // Remove choices if type is not 'choice'
                            if (question.choices && question.type !== 'choice') {
                                delete question.choices;
                            }

                            // Remove null, false, and empty string values
                            question = Object.fromEntries(
                                Object.entries(question).filter(([key, value]) => value !== null && value !== false && value !== '')
                            );

                            return question;
                        });
                });

                return json;
            }

            validateForm() {
                let isValid = true;
                let errorMessages = [];
                let questionIds = new Set();
                let reviewPageCount = 0;
                let reviewPageIndex = -1;

                // Validate form title
                if (!this.title().trim()) {
                    isValid = false;
                    errorMessages.push('Form title is required.');
                }

                this.sections().forEach(section => {
                    // Validate section title
                    if (!section.title().trim()) {
                        isValid = false;
                        errorMessages.push(`Section "${section.sectionId()}" title is required.`);
                    }

                    if (section.reviewPage()) {
                        reviewPageCount++;
                        reviewPageIndex = section.sectionId();
                    }

                    section.questions().forEach(question => {
                        // Validate question title
                        if (!question.title().trim()) {
                            isValid = false;
                            errorMessages.push(`Question "${question.questionId()}" in section "${section.sectionId()}" must have a title.`);
                        }

                        // Check for duplicate questionId
                        if (questionIds.has(question.questionId())) {
                            isValid = false;
                            errorMessages.push(`Duplicate questionId found: "${question.questionId()}" in section "${section.sectionId()}". Each question must have a unique questionId.`);
                        } else {
                            questionIds.add(question.questionId());
                        }

                        // Validate choices for 'choice' type questions
                        if (question.type() === 'choice') {
                            if (question.choices().length === 0) {
                                isValid = false;
                                errorMessages.push(`Question "${question.questionId()}" in section "${section.sectionId()}" must have at least one choice.`);
                            }

                            // Validate unique choices
                            const choiceValues = question.choices().map(choice => choice().trim());
                            const uniqueChoices = new Set(choiceValues);
                            if (uniqueChoices.size !== choiceValues.length) {
                                isValid = false;
                                errorMessages.push(`Question "${question.questionId()}" in section "${section.sectionId()}" has duplicate choices.`);
                            }

                            // Validate multi-choice
                            if (question.multiChoice() && question.choices().length < 2) {
                                isValid = false;
                                errorMessages.push(`Question "${question.questionId()}" in section "${section.sectionId()}" must have at least two choices for multi-choice.`);
                            }
                        }

                        // Validate numeric range
                        if (question.minimum() !== null && question.maximum() !== null && question.minimum() >= question.maximum()) {
                            isValid = false;
                            errorMessages.push(`Question "${question.questionId()}" in section "${section.sectionId()}" has an invalid numeric range. Minimum should be less than maximum.`);
                        }

                        // Validate exclusive minimum/maximum
                        if (question.exclusiveMinimum() && question.minimum() === null) {
                            isValid = false;
                            errorMessages.push(`Question "${question.questionId()}" in section "${section.sectionId()}" has exclusive minimum set but no minimum value.`);
                        }
                        if (question.exclusiveMaximum() && question.maximum() === null) {
                            isValid = false;
                            errorMessages.push(`Question "${question.questionId()}" in section "${section.sectionId()}" has exclusive maximum set but no maximum value.`);
                        }

                        // validate integer vs decimal input
                        if (question.type() === 'integer' && question.minimum() !== null && question.minimum() % 1 !== 0) {
                            isValid = false;
                            errorMessages.push(`Question "${question.questionId()}" in section "${section.sectionId()}" has a minimum value that is not an integer.`);
                        }
                        if (question.type() === 'integer' && question.maximum() !== null && question.maximum() % 1 !== 0) {
                            isValid = false;
                            errorMessages.push(`Question "${question.questionId()}" in section "${section.sectionId()}" has a maximum value that is not an integer.`);
                        }
                    });
                });

                if (reviewPageCount > 1) {
                    isValid = false;
                    errorMessages.push(`There must be exactly one review page.`);
                }

                // A form definition must contain no more than one section marked reviewPage=true. If there are any newPage=true or reviewPage=true on subsequent sections, the definition is invalid. Also, if there are no sections prior to the reviewPage=true, the form is invalid.
                if (reviewPageIndex == 1) {
                    isValid = false;
                    errorMessage.push(`The review page must not be the first section.`);
                }

                if (errorMessages.length > 0) {
                    alert(errorMessages.join('\n'));
                }

                return isValid;
            }

            readJSON(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const json = JSON.parse(e.target.result);
                        this.sections.removeAll();
                        this.formId(json.formId);
                        this.title(json.title);
                        this.description(json.description);
                        this.associatedEntity(json.associatedEntity);
                        json.sections.forEach((sectionData, index) => {
                            const section = new SectionViewModel(index + 1);
                            section.title(sectionData.title);
                            section.subtitle(sectionData.subtitle);
                            section.repeatable(sectionData.repeatable);
                            section.newPage(sectionData.newPage);
                            section.sectionHelpText(sectionData.sectionHelpText);
                            sectionData.questions.forEach(questionData => {
                                const question = new QuestionViewModel(index + 1, questionData.questionId);
                                question.title(questionData.title);
                                question.subtitle(questionData.subtitle);
                                question.type(questionData.type);
                                question.choices(questionData.choices?.map(choice => ko.observable(choice)));
                                question.minimum(questionData.minimum || questionData.exclusiveMinimum);
                                question.maximum(questionData.maximum || questionData.exclusiveMaximum);
                                question.exclusiveMinimum(questionData.exclusiveMinimum);
                                question.exclusiveMaximum(questionData.exclusiveMaximum);
                                question.multiChoice(questionData.multiChoice);
                                question.multiLineText(questionData.multiLineText);
                                question.required(questionData.required);
                                question.forAnnotation(questionData.for);
                                section.questions.push(question);
                            });
                            this.sections.push(section);
                        });
                    };
                    reader.readAsText(file);
                }
            };
        }

        const formViewModel = new FormViewModel();
        ko.applyBindings({ formViewModel });

        // Enable sorting for questions
        $(document).on('mouseover', '.question-list', function () {
            $(this).sortable({
                handle: ".drag-handle",
                update: function (event, ui) {
                    const sectionId = $(this).closest('.section').attr('id').split('_')[1];
                    const section = formViewModel.sections().find(s => s.sectionId() == sectionId);
                    const sortedQuestions = $(this).children('.question').map(function () {
                        const questionId = $(this).attr('id').split('_')[1];
                        return section.questions().find(q => q.questionId() == questionId);
                    }).get();
                    section.questions(sortedQuestions);
                }
            });
        });

        document.getElementById('jsonFileInput').addEventListener('change', function (event) {
            formViewModel.readJSON(event);
        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>
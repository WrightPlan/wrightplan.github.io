<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Register Your Workspace - Field Solutions</title>
    <link rel="icon" href="/favicon.png" type="image/png" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <main class="container">
      <header>
        <img
          class="img-fluid"
          src="/assets/images/logo.png"
          alt="WrightPlan Logo"
        />
        <h1>Field Solutions</h1>
      </header>

      <aside class="alert alert-danger" role="alert" style="display: none">
        <i class="bi-exclamation-triangle"></i>

        The URL is missing <em>deployment</em> and/or
        <em>invitation token</em> information. Please contact your WrightPlan
        administrator and have them resend the Field Solution workspace
        registration link.
      </aside>

      <article>
        <p>
          You have been invited to register a WrightPlan
          <strong>Field Solutions</strong> Workspace for
          <strong name="deployment-name">your company</strong>. Before
          continuing, ensure that you have installed the app on your mobile
          device.
        </p>

        <section>
          <h2>Get the app</h2>
          <p>
            Download the WrightPlan Field Solutions app from your devices' app
            store.
          </p>

          <div class="d-grid gap-2 d-md-block">
            <a
              class="btn btn-primary btn-block"
              href="https://apps.apple.com/us/app/wrightplan-field-solutions/id6478700729"
              target="_blank"
            >
              <i class="bi-apple"></i> App Store
            </a>
            <a
              class="btn btn-primary btn-block"
              href="https://play.google.com/store/apps/details?id=com.wrightplan.fieldsolutions"
              target="_blank"
            >
              <i class="bi-google"></i> Google Play
            </a>
          </div>
        </section>

        <section>
          <h2>Register your workspace</h2>

          <p>There are two options for registering your workspace:</p>

          <section>
            <h3>Scan</h3>
            <p>
              Please scan the following QR code with your mobile device to
              register your workspace.
            </p>
            <figure class="figure" id="qr_code"></figure>
          </section>

          <section>
            <h2>Manual Entry</h2>
            <p>
              Manually enter the following information in the workspace
              registration wizard.
            </p>

            <dl>
              <dt>Workspace</dt>
              <dd>
                <output class="font-monospace" name="workspace"></output>
              </dd>

              <dt>Token</dt>
              <dd>
                <output class="font-monospace" name="token"></output>
              </dd>
            </dl>
          </section>
        </section>

        <section>
          <details>
            <summary>Classic Web Version</summary>
            <p>
              You can still use the classic web-based version of Field Solutions
              by clicking the following button on your mobile device.
            </p>
            <p>
              Note, the web-based version of Field Solutions is approaching
              end-of-life.
            </p>
            <div class="d-grid gap-2 d-md-block">
              <a
                class="btn btn-primary btn-block"
                id="webBasedAnchor"
                href="#Classic"
                target="_blank"
              >
                Web-based
              </a>
            </div>
          </details>
        </section>
      </article>

      <footer
        class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top"
      >
        <div class="col-md-4 d-flex align-items-center">
          <span class="text-muted">&copy; 2024 WrightPlan Inc.</span>
        </div>

        <div class="col-md-4 d-flex align-items-center justify-content-center">
          <a class="link-secondary" href="/privacy/" title="Privacy Policy">
            Privacy Policy
          </a>
        </div>

        <ul class="nav col-md-4 justify-content-end list-unstyled d-flex">
          <li class="ms-3">
            <a
              class="text-muted"
              href="https://www.wrightplan.com"
              title="WrightPlan Inc."
            >
              <i class="bi-house-fill"></i>
            </a>
          </li>
          <li class="ms-3">
            <a
              class="text-muted"
              href="https://ca.linkedin.com/company/wrightplan"
              title="LinkedIn"
            >
              <i class="bi bi-linkedin"></i>
            </a>
          </li>

          <li class="ms-3">
            <a
              class="text-muted"
              href="https://www.facebook.com/wrightplaninc/"
              title="Facebook"
            >
              <i class="bi bi-facebook"></i>
            </a>
          </li>
          <li class="ms-3">
            <a
              class="text-muted"
              href="https://www.instagram.com/wrightplan_inc/"
              title="Instagram"
            >
              <i class="bi bi-instagram"></i>
            </a>
          </li>
          <li class="ms-3">
            <a
              class="text-muted"
              href="https://www.youtube.com/channel/UCbX3urqGKHn-a6fuRbimsaw"
              title="YouTube"
            >
              <i class="bi bi-youtube"></i>
            </a>
          </li>
        </ul>
      </footer>
    </main>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"
      integrity="sha256-xUHvBjJ4hahBW8qN9gceFBibSFUzbe9PNttUvehITzY="
      crossorigin="anonymous"
    ></script>

    <script type="text/javascript">
      const localHosts = new Set(["localhost", "127.0.0.1"]);
      const generateUrl = (workspace, relativePath) => {
        const baseUrl = new URL(`https://${workspace}`);

        let basePath = baseUrl.pathname;
        if (basePath.endsWith("/")) {
          basePath = basePath.slice(0, -1);
        }

        const path = `${basePath}${relativePath}`;
        const url = new URL(path, baseUrl);

        if (localHosts.has(url.hostname)) {
          url.protocol = "http";
        }

        return url;
      };

      const generateClassicWebLoginUrl = (workspace, token) => {
        const redeemUrl = generateUrl(
          workspace,
          `/Api/resources/employees/redeem-login/${encodeURIComponent(token)}`
        );
        const fsLoginUrl = generateUrl(workspace, "/FS/login.html");
        fsLoginUrl.hash = `#redemptionLink=${redeemUrl.pathname}`;

        return fsLoginUrl.href;
      };

      const fetchDeploymentName = async (workspace) => {
        const brandingUrl = generateUrl(workspace, "/Api/branding");

        const response = await fetch(brandingUrl.href, {
          method: "GET",
          credentials: "omit",
          mode: "cors",
          headers: {
            Accept: "application/json",
          },
        });
        const brandingDto = await response.json();
        const branding = brandingDto?.data;

        return branding?.deploymentName || workspace;
      };

      const generateQRCode = () => {
        const options = {
          text: window.location.href,
          correctLevel: QRCode.CorrectLevel.M,
          width: 256,
          height: 256,
        };
        new QRCode(document.getElementById("qr_code"), options);
      };

      const showDeploymentName = (name) => {
        document.getElementsByName("deployment-name").forEach((element) => {
          element.innerText = name;
        });
      };

      const showRegistrationInfo = (workspace, token) => {
        document.getElementsByName("workspace").forEach((element) => {
          element.innerText = workspace;
        });
        document.getElementsByName("token").forEach((element) => {
          element.innerText = token;
        });

        const classicWebLoginUrl = generateClassicWebLoginUrl(workspace, token);
        const classicAnchor = document.getElementById("webBasedAnchor");
        classicAnchor.href = classicWebLoginUrl;

        generateQRCode();

        fetchDeploymentName(workspace)
          .then(showDeploymentName)
          .catch(() => showDeploymentName(workspace));
      };

      addEventListener("load", () => {
        const params = new URL(document.location).searchParams;
        const workspace = params.get("workspace");
        const token = params.get("token");

        if (workspace && token) {
          showRegistrationInfo(workspace, token);
        } else {
          document.getElementsByClassName("alert-danger")[0].style.display =
            "block";
          document.getElementsByTagName("article")[0].style.display = "none";
        }
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Register - WrightPlan FieldSolutions</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  </head>
  <body>
    <main class="container">
      <header>
        <img
          class="img-fluid"
          src="https://images.squarespace-cdn.com/content/v1/60df54ee6e3fcd18ab31b713/9a97ffd7-12e2-4a7b-9e9c-755d3bede9cf/WP+LOGO_Software_Small.png?format=1500w"
          alt="WrightPlan FieldSolutions Logo"
        />
        <h1>
          WrightPlan FieldSolutions
          <div class="small">Register Workspace</div>
        </h1>
      </header>
      <article>
        <p>
          You have been invited to register a FieldSolutions workspace for
          <strong name="workspace">WORKSPACE</strong>. You will need to ensure
          that you have the
          <strong>WrightPlan FieldSolutions</strong> application installed on
          your mobile device.
        </p>

        <section>
          <h2>Scan</h2>
          <p>
            Please scan the following QR code with your mobile device to
            register your workspace.
          </p>
          <figure class="figure" id="qr_code"></figure>
        </section>
        <section>
          <h2>Manual Entry</h2>
          <p>
            Alternatively, manually enter the following information in the
            FieldSolutions application.
          </p>

          <dl>
            <dt>Workspace</dt>
            <dd><output class="font-monospace" name="workspace"></output></dd>

            <dt>Token</dt>
            <dd><output class="font-monospace" name="token"></output></dd>
          </dl>
        </section>

        <details>
          <summary>Classic Web Version</summary>
          <p>
            You can still use the classic web-based version of FieldSolutions by
            clicking the following button on your mobile device.
          </p>
          <p>
            Note, the web-based version of FieldSolutions is approaching
            end-of-life.
          </p>
          <div class="d-grid gap-2 d-md-block">
            <a
              class="btn btn-primary btn-block"
              id="webBasedAnchor"
              href="#Classic"
              >Web-based</a
            >
          </div>
        </details>
      </article>
      <footer class="text-center">
        <hr />
        &copy; 2024 WrightPlan Inc.
      </footer>
    </main>
    <script type="text/javascript">
      function generateClassicWebLoginUrl(workspace, token) {
        const baseUrl = new URL(`https://${workspace}`);

        let basePath = baseUrl.pathname;
        if (basePath.endsWith("/")) {
          basePath = basePath.slice(0, -1);
        }

        const redeemUrl = new URL(
          `${basePath}/Api/resources/employees/redeem-login/${token}`,
          baseUrl
        );
        const fsLoginUrl = new URL(`${basePath}/FS/login.html`, baseUrl);
        fsLoginUrl.hash = `#redemptionLink=${redeemUrl.pathname}`;

        return fsLoginUrl.href;
      }

      function generateQRCode() {
        new QRCode(document.getElementById("qr_code"), window.location.href);
      }

      function showRegistrationInfo(workspace, token) {
        document.getElementsByName("workspace").forEach((element) => {
          element.innerText = workspace;
        });
        document.getElementsByName("token").forEach((element) => {
          element.innerText = token;
        });

        const classicWebLoginUrl = generateClassicWebLoginUrl(workspace, token);
        const classicAnchor = document.getElementById("webBasedAnchor");
        classicAnchor.href = classicWebLoginUrl;

        generateQRCode();
      }

      function onLoaded() {
        const params = new URL(document.location).searchParams;
        const workspace = params.get("workspace");
        const token = params.get("token");

        if (workspace && token) {
          showRegistrationInfo(workspace, token);
        } else {
          window.alert(
            "Invalid registration link. Please contact your administrator."
          );

          // window.location.replace("/");
        }
      }

      addEventListener("load", onLoaded);
    </script>
  </body>
</html>
